<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>js-image-compress</title>
  <script src="./util.js"></script>
</head>

<body>
  <div>
    <input type="file" id="file">
  </div>
  <div>
    <img src="" id="origin">
  </div>

  <div>
    <img src="" id="output" />
  </div>

  <script>
    var fileEle = document.getElementById('file');

    fileEle.addEventListener('change', function () {
      file = this.files[0];
      console.log('压缩之前图片尺寸大小: ', file.size);
      // 将上传图片在页面预览
      util.file2DataUrl(file, function (url) {
        document.getElementById('origin').src = url;
      })

      var options = {
        file: file,
        quality: 0.6,
        mimeType: 'image/png',
        success: function (result) {
          console.log('压缩之后图片尺寸大小: ', result.size);
          console.log('压缩率： ', (result.size / file.size).toFixed(4) * 100 + '%');

          // 生成压缩后图片在页面展示
          util.file2DataUrl(result, function (url) {
            document.getElementById('output').src = url;
          })
          // 上传到远程服务器
          // util.upload('/upload.png', result);
        }
      };

      simpleImageCompressor(options);
    }, false);

    function simpleImageCompressor(options) {
      var file = options.file;
      var quality = options.quality || 0.8;
      var imageType = /^image\//;

      if (!file || !imageType.test(file.type)) {
        console.error('请上传图片文件!');
        return;
      }

      util.file2Image(file, function (img) {
        var canvas = util.image2Canvas(img);
        util.canvas2Blob(canvas, function (blob) {
          options.success && options.success(blob);
        }, options.quality, options.mimeType)
      })
    }
  </script>
</body>

</html>