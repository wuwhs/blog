---
title: realize-at
date: 2022-09-15 17:08:30
tags: [javascript html5]
---

## èƒŒæ™¯

ä¸€å¤©äº§å“å¤§å¤§å‘ boss æ±‡æŠ¥å®Œç ”å‘æˆæœå’Œäº§å“ä¸šç»©äº§å‡ºï¼Œè‹¥æœ‰æ‰€æ€çš„èµ°å‡ºæ¥ï¼ŒåŠ²ç›´å‘æˆ‘èµ°è¿‡æ¥ï¼Œå˜´è§’å¾®å¾®ä¸Šæ‰¬ã€‚
äº§å“å¤§å¤§ï¼šboss å¯¹æˆ‘ä»¬çš„ç ”å‘æˆæœæŒºæ»¡æ„çš„ï¼Œbalabala...ï¼ˆå†…å¿ƒ OSï¼šä¸å¬ï¼Œè®²é‡ç‚¹ï¼‰
äº§å“å¤§å¤§ï¼šå’±ä»¬çš„å®¢æœ IM æ¡Œé¢å®¢æˆ·ç«¯ç°åœ¨å·²ç»æœ‰èƒ½åŠ›åšåˆ° 1 å¯¹å¤šæ¥å¾…åœ¨çº¿è®¿å®¢äº†ï¼Œåé¢æˆ‘ä»¬æƒ³è¦å°†ä¸“é¡¹é—®é¢˜è®¿å®¢åœ¨å½“å‰æ¥å¾…å®¢æœä¸èƒ½è§£å†³çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥æ‹‰ä¸“é¡¹å®¢æœå‘èµ·ç¾¤èŠã€‚
æˆ‘ï¼šå—¯ï¼Œè¿™ä¸ªæƒ³æ³•ä¸é”™ï¼Œä¸“é¡¹å®¢æœè¿˜èƒ½ä¸€çœ¼çœ‹åˆ°ä¹‹å‰å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œè®¿å®¢è¿˜æ— é¡»é‡æ–°å‘èµ·èŠå¤©ã€‚
å“’å“’å“’ï¼ŒåŠŸèƒ½åšå®Œäº†ï¼Œä¸¤å‘¨åä¸Šçº¿éªŒæ”¶ï¼Œå®¢æˆ·å¾ˆæ»¡æ„ï¼Œboss åœ¨ç¾¤é‡Œä¹Ÿç‚¹äº†ä¸ª ğŸ‘ğŸ»ã€‚
äº§å“å¤§å¤§åˆæ¥äº†ï¼šå—¯ï¼Œè¿™ä¸ªåŠŸèƒ½ä¸é”™ï¼Œæˆ‘ä»¬ä¹Ÿæ”¯æŒç»™å®¢æœè‡ªå·±ç¾¤èŠå§ï¼Œæœ‰åŠ©äºå®¢æœç¾¤ä½“æ²Ÿé€šå’Œé—®é¢˜åé¦ˆã€‚
æˆ‘ï¼šå—¯ï¼Œè¿™ä¸ªæƒ³æ³•ä¹Ÿä¸é”™ï¼Œç¾¤èŠçš„å†…å®¹ä¹Ÿæœ‰åŠ©äºåæœŸçš„ç”¨æˆ·å£°éŸ³æ•°æ®æŒ–æ˜ã€‚
å“å“å“ï¼Œåšå¥½äº†ï¼Œä¸Šçº¿ï¼Œè°ƒæ•´å¥½å¿ƒæ€ï¼Œé™ç­‰è¢«å„è·¯å¤§ä½¬ ğŸ‘ğŸ» æ·¹æ²¡ã€‚
å®¢æœ Aï¼šææ¯›å•Šï¼Œä½ ä»¬ç¾¤èŠéƒ½ä¸ç»™ä¸ª@åŠŸèƒ½ï¼Œæˆ‘æ€ä¹ˆ diao ä½ ä»¬ç ”å‘å•Šã€‚
å®¢æœ B/C/Dï¼šâ•10086ã€‚
æˆ‘ï¼šã€‚ã€‚ã€‚
å“ˆå“ˆå“ˆï¼Œä¸Šé¢çš„è™šæ‹Ÿåœºæ™¯çº¯å±å¥½ç©ï¼Œä¸‹é¢å°±æ€æ ·å®Œç¾çš„å®ç°ä¸€ä¸ª@åŠŸèƒ½å±•å¼€ï¼ŒåŒ…æ•™åŒ…ä¼šã€‚
åœ¨è¿›å…¥æ­£é¢˜ä¹‹å‰ï¼Œå’±ä»¬å…ˆé¢„å¤‡ä¸€äº›å¯¹å…‰æ ‡é€‰åŒºçš„â€œåŸºæ“â€çŸ¥è¯†ã€‚è€Œå¯¹å…‰æ ‡é€‰åŒºçš„æ“ä½œåœ¨é¡µé¢ä¸Šçš„å…ƒç´ å¤§è‡´åˆ†ä¸ºä¸¤å¤§ç±»ï¼štext/textarea æ–‡æœ¬è¾“å…¥æ¡†å…ƒç´ å’Œå¯Œæ–‡æœ¬å…ƒç´ ã€‚ä¸‹é¢åˆ†åˆ«å¯¹ä¸€äº›å¸¸ç”¨ API è¿›è¡Œç®€å•ä»‹ç»ã€‚

## text/textarea æ–‡æœ¬è¾“å…¥æ¡†ä¸­æ“ä½œå…‰æ ‡é€‰åŒº

é¦–å…ˆçœ‹è¿™ç±»æ“ä½œæ–¹å¼ï¼Œå‡ ä¹å¯ä»¥ä¸ç”¨ `Selection`å’Œ `Range`ç›¸å…³ APIï¼Œä½¿ç”¨çš„æ˜¯æ–‡æœ¬è¾“å…¥æ¡†å…ƒç´ åŸç”Ÿæ–¹æ³•ã€‚

### ä¸»åŠ¨é€‰ä¸­æŸä¸€åŒºåŸŸ

ä¸»åŠ¨é€‰ä¸­åœ¨æ–‡æœ¬è¾“å…¥æ¡†å…ƒç´ æŸä¸€åŒºåŸŸå¯ä»¥ä½¿ç”¨ [setSelectionRange](https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLInputElement/setSelectionRange) ã€‚

> element.setSelectionRange(selectionStart, selectionEnd [, selectionDirection]);

- selectionStart è¢«é€‰ä¸­çš„ç¬¬ä¸€ä¸ªå­—ç¬¦çš„ä½ç½®ç´¢å¼•ï¼Œä» 0 å¼€å§‹ã€‚
- selectionEnd è¢«é€‰ä¸­çš„æœ€åä¸€ä¸ªå­—ç¬¦çš„ ä¸‹ä¸€ä¸ª ä½ç½®ç´¢å¼•ã€‚
- selectionDirection é€‰æ‹©æ–¹å‘çš„å­—ç¬¦ä¸²ã€‚

```javascript
$input.setSelectionRange(0, 6)
// $input.select() // å…¨éƒ¨é€‰ä¸­
$input.focus()
```

![setSelectionRange.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662389649885-df19671d-6b75-4375-8ea1-310481544199.gif)

### èšç„¦åˆ°æŸä¸€ä½ç½®

å¦‚æœæˆ‘ä»¬æƒ³æŠŠå…‰æ ‡ç§»åŠ¨åˆ° ğŸ˜ƒğŸ˜„ğŸ˜ åé¢ï¼Œå…¶å®æ˜¯å°†é€‰åŒºèµ·å§‹ä½ç½®è®¾ç½®ç›¸åŒçš„æ•ˆæœ

```javascript
$input.setSelectionRange(6, 6)
$input.focus()
```

![setSelectionRange1.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662389674758-aec15344-10ed-40a0-be3c-34cd2cde513b.gif)

### è¿˜åŸä¹‹å‰çš„é€‰åŒº

æœ‰äº›åœºæ™¯ï¼Œæˆ‘ä»¬é€‰æ‹©äº†å½“å‰`input`æ–‡æœ¬æ¡†é€‰åŒºï¼Œè¦å»åšåˆ«çš„æ“ä½œï¼Œå›æ¥åè¦æ¢å¤é€‰åŒºï¼Œè¿™æ—¶åœ¨åšåˆ«çš„æ“ä½œä¹‹å‰å°±è¦å°†é€‰åŒºä½ç½®å­˜ä¸‹æ¥ï¼Œä¼šç”¨åˆ°`selectionStart`å’Œ `selectionEnd`ä¸¤ä¸ªå±æ€§ã€‚

```javascript
$input.addEventListener('mouseup', () => {
  this.pos = {
    start: $input.selectionStart,
    end: $input.selectionEnd
  }
})

const { start, end } = this.pos
$input.setSelectionRange(start, end)
$input.focus()
```

![setSelectionRange2.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662389710497-a13651e7-3f6e-40d5-82dd-f2f4b9ad5901.gif)

### åœ¨æŒ‡å®šé€‰åŒºæ’å…¥ï¼ˆæ›¿æ¢ï¼‰å†…å®¹

æŒ‡å®šæ–‡æœ¬è¾“å…¥æ¡†çš„æŸä¸ªä½ç½®æ’å…¥å†…å®¹æˆ–è€…æ›¿æ¢é€‰åŒºçš„å†…å®¹ï¼Œå¯ä»¥ä½¿ç”¨ [setRangeText](https://developer.mozilla.org/en-US/docs/Web/API/HTMLInputElement/setRangeText) å®ç°ã€‚

> setRangeText(replacement)
> setRangeText(replacement, start, end, selectMode)

è¿™ä¸ªæ–¹æ³•æœ‰ 2 ç§å½¢å¼ï¼Œç¬¬äºŒç§å½¢å¼æœ‰ 4 ä¸ªå‚æ•°ï¼š

- ç¬¬ä¸€ä¸ªå‚æ•°`replacement`æ˜¯æ›¿æ¢æ–‡æœ¬ï¼›
- `start`å’Œ `end`æ˜¯èµ·å§‹ä½ç½®ï¼Œé»˜è®¤å€¼è¯¥å…ƒç´ å½“å‰é€‰ä¸­çš„åŒºåŸŸçš„ä½ç½®ï¼›
- æœ€åä¸€ä¸ªå‚æ•°`selectMode`æ˜¯æ›¿æ¢åé€‰åŒºçš„çŠ¶æ€ï¼Œå®ƒæœ‰ 4 ä¸ªçŠ¶æ€ï¼šselectï¼ˆæ›¿æ¢åé€‰ä¸­ï¼‰ã€startï¼ˆæ›¿æ¢åå…‰æ ‡ä½äºæ›¿æ¢è¯ä¹‹å‰ï¼‰ã€endï¼ˆæ›¿æ¢åå…‰æ ‡ä½äºæ›¿æ¢è¯ä¹‹åï¼‰å’Œ preserveï¼ˆé»˜è®¤å€¼ï¼Œå°è¯•ä¿ç•™é€‰åŒºï¼‰ï¼›

æˆ‘ä»¬å°†å…‰æ ‡æˆ–è€…é€‰åŒºä½ç½®æ’å…¥æˆ–è€…æ›¿æ¢æ–‡æœ¬ ğŸ˜‚ğŸ˜‚ğŸ˜‚ï¼Œå¯ä»¥è¿™æ ·

```javascript
$input.setRangeText('ğŸ˜‚ğŸ˜‚ğŸ˜‚')
$input.focus()
```

![setRangeText.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662389727309-4831ce20-3bea-4b0c-9bec-86219a9c6427.gif)
ä¸‹é¢å†æ¥çœ‹çœ‹ç¬¬äºŒç§æœ‰ 4 ä¸ªå‚æ•°å½¢å¼ï¼Œå‘ç°ä¼šåœ¨æˆ‘ä»¬æŒ‡å®šçš„èµ·å§‹ä½ç½®æ’å…¥å†…å®¹åï¼Œå½“å‰çš„é€‰åŒºå’Œå…‰æ ‡å°è¯•ä¿ç•™ã€‚æ›¿æ¢åé€‰åŒºçš„çŠ¶æ€å¦å¤– 3 ç§åœºæ™¯å¤§å®¶å¯ä»¥è‡ªè¡Œæµ‹è¯•ã€‚

```javascript
$input.setRangeText('ğŸ˜‚ğŸ˜‚ğŸ˜‚', 8, 8, 'preserve')
$input.focus()
```

![setRangeText1.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662389742937-1b7b8b0c-2e1d-482a-8e45-f86b3c01620a.gif)
å…³äºé€‰åŒºçš„æ“ä½œåœ¨ input/textarea è¾“å…¥æ¡†ä¸­çš„æ“ä½œå¸¸ç”¨çš„å·®ä¸å¤šå°±è¿™äº›ï¼Œä¸‹é¢ç®€å•æ€»ç»“ä¸€ä¸‹
![](https://cdn.nlark.com/yuque/0/2022/jpeg/22627045/1663148689420-1c042136-3b5a-4f15-ab7f-0c706a62568e.jpeg)

## å¯Œæ–‡æœ¬ä¸­æ“ä½œå…‰æ ‡é€‰åŒºâ€”â€”Selection & Range

### è®¾ç½®å¯Œæ–‡æœ¬

é¦–å…ˆå¯Œæ–‡æœ¬å…ƒç´ æ˜¯å¯ç¼–è¾‘å…ƒç´ ï¼Œå¯ä»¥åœ¨å…ƒç´ ä¸Šçœ‹åˆ°å…‰æ ‡ï¼Œé™¤äº†è¡¨å•å…ƒç´ ï¼Œè¿˜æœ‰ç»™æ™®é€šå…ƒç´ æ·»åŠ å±æ€§å¯ä»¥è½¬æ¢æ–‡å¯Œæ–‡æœ¬å…ƒç´ ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸‹ä¸‰ç§æ–¹å¼è½¬æ¢ã€‚

- ç»™å…ƒç´ æ·»åŠ å±æ€§ `contenteditable="true"`ï¼›
- æ·»åŠ  CSS å±æ€§ `-webkit-user-modify: "read-write"`ï¼›
- é€šè¿‡ js çš„ `document.designMode="on"`æ–¹å¼è®¾ç½®ï¼›

### Selection & Range

åœ¨å¯Œæ–‡æœ¬ä¸­å¯¹å…‰æ ‡åŠé€‰åŒºçš„æ“ä½œï¼Œä¸å¾—ä¸æ JavaScript çš„ä¸¤ä¸ªåŸç”Ÿå¯¹è±¡ï¼š [Selection](https://developer.mozilla.org/zh-CN/docs/Web/API/Selection) å’Œ [Range](https://developer.mozilla.org/zh-CN/docs/Web/API/Range/Range) ã€‚

- **Selection** å¯¹è±¡è¡¨ç¤ºç”¨æˆ·é€‰æ‹©çš„æ–‡æœ¬èŒƒå›´æˆ–æ’å…¥ç¬¦å·çš„å½“å‰ä½ç½®ã€‚å®ƒä»£è¡¨é¡µé¢ä¸­çš„æ–‡æœ¬é€‰åŒºï¼Œå¯èƒ½æ¨ªè·¨å¤šä¸ªå…ƒç´ ã€‚æ–‡æœ¬é€‰åŒºç”±ç”¨æˆ·æ‹–æ‹½é¼ æ ‡ç»è¿‡æ–‡å­—è€Œäº§ç”Ÿã€‚è¦è·å–ç”¨äºæ£€æŸ¥æˆ–ä¿®æ”¹çš„ `Selection` å¯¹è±¡ï¼Œè¯·è°ƒç”¨ [window.getSelection()](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/getSelection)ã€‚
- **Range** å¯¹è±¡è¡¨ç¤ºåŒ…å«èŠ‚ç‚¹å’Œéƒ¨åˆ†æ–‡æœ¬èŠ‚ç‚¹çš„æ–‡æ¡£ç‰‡æ®µã€‚é€šè¿‡ `selection`å¯¹è±¡è·å¾—çš„ `range`å¯¹è±¡æ‰æ˜¯æˆ‘ä»¬æ“ä½œå…‰æ ‡çš„é‡ç‚¹ã€‚

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22627045/1662215604275-69e9f544-0b5a-4ba1-acf7-2d6a49928d03.png)
å¤§å®¶å¯èƒ½æ³¨æ„åˆ° `getRangeAt(0)`ï¼Œé€‰åŒºå¯èƒ½ä¼šæœ‰å¤šä¸ª `range`? è¿˜çœŸæ˜¯ï¼Œåœ¨ Firefox æ”¯æŒå¤šä¸ªé€‰åŒºï¼Œé€šè¿‡ `cmd`é”®ï¼ˆ`windows`ä¸Šæ˜¯ `ctrl`é”®ï¼‰å¯ä»¥å®ç°å¤šé€‰åŒºã€‚
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22627045/1662216141776-85c105ca-898d-4821-b132-cd703eaab3df.png)
å†çœ‹ä¸€ä¸ª range è¿”å›çš„ä¸€ä¸ªå±æ€§ï¼Œ`collapsed`ï¼Œè¡¨ç¤ºé€‰åŒºçš„èµ·ç‚¹ä¸ç»ˆç‚¹æ˜¯å¦é‡å ã€‚å½“`collapsed`ä¸º`true`æ—¶ï¼Œé€‰ä¸­åŒºåŸŸè¢«å‹ç¼©æˆä¸€ä¸ªç‚¹ï¼Œå¯¹äºæ™®é€šçš„å…ƒç´ ï¼Œå¯èƒ½ä»€ä¹ˆéƒ½çœ‹ä¸åˆ°ï¼Œå¦‚æœæ˜¯åœ¨å¯ç¼–è¾‘å…ƒç´ ä¸Šï¼Œé‚£è¿™ä¸ªè¢«å‹ç¼©çš„ç‚¹å°±å˜æˆäº†å¯ä»¥é—ªçƒçš„å…‰æ ‡ã€‚

### ä¸»åŠ¨é€‰ä¸­å¯Œæ–‡æœ¬çš„æŸä¸ªèŠ‚ç‚¹

é€‰ä¸­å¯Œæ–‡æœ¬ä¸­çš„æŸä¸ªç‹¬ç«‹æ ‡ç­¾ï¼Œå¯ä»¥ç”¨åˆ°ä¸¤ä¸ª APIï¼Œ[Range.selectNode()](https://developer.mozilla.org/zh-CN/docs/Web/API/Range/selectNode) å’Œ [Range.selectNodeContent()](https://developer.mozilla.org/zh-CN/docs/Web/API/Range/selectNodeContents)ï¼Œä¸¤è€…ä¸åŒçš„æ˜¯å‰è€…åŒ…æ‹¬èŠ‚ç‚¹è‡ªèº«ï¼Œåè€…ä¸åŒ…æ‹¬è‡ªèº«ã€‚æ¯”å¦‚æˆ‘ä»¬æƒ³ç‹¬ç«‹é€‰ä¸­å¯Œæ–‡æœ¬çš„ç¬¬äºŒä¸ªå­å…ƒç´ `<span style="color: #00965e;">Selection</span>` ï¼Œä½¿ç”¨ `Range.selectNode()` API é€‰ä¸­å…ƒç´ ï¼Œåˆ é™¤çš„æ˜¯æ•´ä¸ªå…ƒç´ ï¼Œå†è¾“å…¥å†…å®¹æ˜¯æ²¡æœ‰æ ·å¼çš„ã€‚

```javascript
const $span = $input.childNodes[1]
range.selectNode($span)
selection.removeAllRanges()
selection.addRange(range)
```

![selectNode1.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662435977354-b19ed561-61ec-4d8f-a184-9ae73f1f9b07.gif)
å½“ç„¶éƒ¨åˆ†æµè§ˆå™¨ï¼ˆæ¯”å¦‚ Chrome104ï¼‰æ˜¯æœ‰å·®å¼‚çš„ï¼Œåœ¨åˆ é™¤æ•´ä¸ªèŠ‚ç‚¹åï¼Œæ–°è¾“å…¥çš„å†…å®¹æ—¶ä¼šæ’å…¥ä¸€ä¸ªæ ‡ç­¾ï¼ˆ`font`ï¼‰å¹¶é›†æˆä¹‹å‰çš„æ ·å¼ã€‚
![selectNode.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662436107528-1001e4af-e644-4571-8d26-ee085792e019.gif)
ä½¿ç”¨ `Range.selectNodeContents()` API é€‰ä¸­çš„æ˜¯èŠ‚ç‚¹å†…éƒ¨å†…å®¹ï¼Œå½“åˆ é™¤é€‰ä¸­å†…å®¹åï¼ŒèŠ‚ç‚¹æœ¬èº«è¿˜åœ¨ã€‚

```javascript
const $span = $input.childNodes[1]
range.selectNodeContents($span)
selection.removeAllRanges()
selection.addRange(range)
```

![selectNode2.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662436465512-d56fa927-a301-4e5a-b039-5e32c4443b07.gif)
ä»¥ä¸Šæ˜¯å¯¹å¯Œæ–‡æœ¬ä¸­å•ä¸ªèŠ‚ç‚¹çš„é€‰ä¸­æ“ä½œï¼Œç„¶è€Œï¼Œå®é™…ä¸Šå¯Œæ–‡æœ¬ä¸­çš„èŠ‚ç‚¹å¯èƒ½æ˜¯åµŒå¥—æˆ–è€…å¹³è¡Œçš„ï¼Œæ€æ ·è·¨å¤šä¸ªå…ƒç´ å»é€‰ä¸­æ“ä½œå‘¢ï¼Ÿ

### ä¸»åŠ¨é€‰ä¸­å¯Œæ–‡æœ¬çš„æŸä¸€åŒºåŸŸ

è¡¨å•è¾“å…¥æ¡†åªæœ‰å•ä¸€æ–‡æœ¬ï¼Œè€Œå¯Œæ–‡æœ¬å…ƒç´ æˆ–è€…æ™®é€šå…ƒç´ åŒ…å«å¤šä¸ªå…ƒç´ ã€‚å½“ä¸»åŠ¨é€‰ä¸­é¡µé¢æŸä¸€åŒºåŸŸï¼Œå…ˆè¦åˆ›å»ºä¸€ä¸ª`Range`å¯¹è±¡ï¼Œå¯èƒ½ä¼šè·¨å¤šä¸ªå…ƒç´ ï¼Œæ‰€ä»¥è¦è®¾ç½®é€‰åŒºçš„èµ·å§‹èŠ‚ç‚¹ï¼Œåˆ†åˆ«æ˜¯ [Range.setStart()](https://developer.mozilla.org/zh-CN/docs/Web/API/Range/setStart) å’Œ [Range.setEnd()](https://developer.mozilla.org/zh-CN/docs/Web/API/Range/setEnd) æ–¹æ³•ã€‚

> range.setStart(startNode, startOffset);
> range.setEnd(endNode, endOffset);

- startNode å¼€å§‹èŠ‚ç‚¹
- startOffset ä» startNode çš„å¼€å§‹ä½ç½®ç®—èµ·çš„åç§»é‡
- endNode ç»“æŸèŠ‚ç‚¹
- endOffset ä» endNode çš„ç»“æŸä½ç½®ç®—èµ·çš„åç§»é‡

ä¸Šé¢æ˜¯è®¾ç½®é€‰åŒºèŒƒå›´ï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°é€‰åŒºå¹¶é€‰ä¸­ [Selection.addRange()](https://developer.mozilla.org/zh-CN/docs/Web/API/Selection/addRange)ã€‚ä¸è¿‡ï¼Œä¸€èˆ¬åœ¨æ·»åŠ å‰ï¼Œä¼šæ¸…é™¤ä¹‹å‰çš„é€‰åŒºï¼Œè¿™æ—¶å°±è¦ç”¨åˆ° [Selection.removeAllRanges()](https://developer.mozilla.org/zh-CN/docs/Web/API/Selection/removeAllRanges) ã€‚

```javascript
const selection = document.getSelection()
const range = document.createRange()
range.setStart($input.firstChild, 0)
range.setEnd($input.firstChild, 4)
selection.removeAllRanges()
selection.addRange(range)
```

![addRange.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662390599870-23189fbe-5149-43dc-8492-5d06e425464e.gif)
æ³¨æ„è¿™é‡Œå–å¯Œæ–‡æœ¬å…ƒç´ çš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ï¼ˆæ–‡æœ¬èŠ‚ç‚¹ï¼‰ï¼Œè€Œä¸æ˜¯å…ƒç´ æœ¬èº«ï¼Œå¦åˆ™å°±ä¼šè¶…å‡ºåç§»é‡ï¼Œå‡ºç°æŠ¥é”™ã€‚å› ä¸ºåœ¨è®¡ç®—å…ƒç´ èŠ‚ç‚¹å’Œæ–‡æœ¬èŠ‚ç‚¹åç§»é‡æ˜¯æœ‰å·®åˆ«çš„ï¼š

> å¦‚æœèµ·å§‹èŠ‚ç‚¹ç±»å‹æ˜¯ Textã€Comment æˆ– CDATASection ä¹‹ä¸€ï¼Œé‚£ä¹ˆ startOffset æŒ‡çš„æ˜¯ä»èµ·å§‹èŠ‚ç‚¹ç®—èµ·å­—ç¬¦çš„åç§»é‡ã€‚ å¯¹äºå…¶ä»– Node ç±»å‹èŠ‚ç‚¹ï¼ŒstartOffset æ˜¯æŒ‡ä»èµ·å§‹ç»“ç‚¹å¼€å§‹ç®—èµ·å­èŠ‚ç‚¹çš„åç§»é‡ã€‚

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚æœæˆ‘æƒ³é€‰ä¸­å¯Œæ–‡æœ¬å¼€å¤´è¿™ä¸€æ®µ `ğŸ˜ƒğŸ˜„ğŸ˜<span style="color: #00965e;">Selection</span> å¯¹è±¡`ï¼Œæ€æ ·å®ç°å‘¢ï¼Ÿ
å¯¹äºæ¯”è¾ƒå¤æ‚çš„å¯Œæ–‡æœ¬å…ƒç´ ç»“æ„ï¼Œè¦å®ç°ä»»æ„åŒºé—´é€‰ä¸­ï¼Œå…³é”®è¦æ‰¾åˆ°èµ·å§‹èŠ‚ç‚¹å’Œç»“æŸèŠ‚ç‚¹ï¼Œä»¥åŠå®ƒä»¬å„è‡ªçš„åç§»é‡ã€‚
![](https://cdn.nlark.com/yuque/0/2022/jpeg/22627045/1662446157651-fd9d9bad-f924-4c19-b706-7b94d20751e8.jpeg)

å¥½åƒæ²¡æœ‰æ›´å¥½çš„åŸç”Ÿæ–¹æ³•å¯ä»¥å€ŸåŠ©ï¼Œè¿™é‡Œæœ‰ä¸€ç§æ–¹æ¡ˆï¼Œé¦–å…ˆéå†å‡ºå¯Œæ–‡æœ¬åŒ…å«æ‰€æœ‰çš„æ–‡æœ¬èŠ‚ç‚¹ï¼Œç„¶åè®°å½•æ¯ä¸ªèŠ‚ç‚¹è¾¹ç•Œçš„åç§»é‡ï¼ŒæŸ¥æ‰¾å‡ºæ»¡è¶³åŒºé—´æ¡ä»¶çš„èµ·å§‹å’Œç»“æŸèŠ‚ç‚¹ï¼Œæœ€åä»èµ·å§‹å’Œç»“æŸèŠ‚ç‚¹ä¸­è®¡ç®—å„è‡ªéœ€è¦çš„æ–‡æœ¬åç§»é‡ã€‚

```javascript
/**
 * è·å–æ‰€æœ‰æ–‡æœ¬èŠ‚ç‚¹åŠå…¶åç§»é‡
 * @param {HTMLElement} wrapDom æœ€å¤–å±‚èŠ‚ç‚¹
 * @param {Number} start å¼€å§‹ä½ç½®
 * @param {Number} end ç»“æŸä½ç½®
 * @returns
 */
function getNodeAndOffset(wrapDom, start = 0, end = 0) {
  const txtList = []
  const map = function (children) {
    ;[...children].forEach((el) => {
      if (el.nodeName === '#text') {
        txtList.push(el)
      } else {
        map(el.childNodes)
      }
    })
  }
  // é€’å½’éå†ï¼Œæå–å‡ºæ‰€æœ‰ #text
  map(wrapDom.childNodes)
  // è®¡ç®—æ–‡æœ¬çš„ä½ç½®åŒºé—´
  const clips = txtList.reduce((arr, item, index) => {
    const end = item.textContent.length + (arr[index - 1] ? arr[index - 1][2] : 0)
    arr.push([item, end - item.textContent.length, end])
    return arr
  }, [])
  // æŸ¥æ‰¾æ»¡è¶³æ¡ä»¶çš„èŒƒå›´åŒºé—´
  const startNode = clips.find((el) => start >= el[1] && start < el[2])
  const endNode = clips.find((el) => end >= el[1] && end < el[2])
  return [startNode[0], start - startNode[1], endNode[0], end - endNode[1]]
}
```

æœ‰äº†è¿™ä¸ªæˆ‘ä»¬è‡ªå·±å°è£…çš„å·¥å…·æ–¹æ³•ï¼Œå°±å¯ä»¥é€‰ä¸­ä»»æ„æ–‡å­—åŒºé—´ï¼Œè€Œä¸ç”¨è€ƒè™‘å¯Œæ–‡æœ¬çš„å…ƒç´ ç»“æ„ã€‚

```javascript
const selection = document.getSelection()
const range = document.createRange()
const nodes = this.getNodeAndOffset($input, 4, 17)
range.setStart(nodes[0], nodes[1])
range.setEnd(nodes[2], nodes[3])
selection.removeAllRanges()
selection.addRange(range)
```

![getNodeAndOffset.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662448203808-f82a4bb4-6eaf-4977-983e-42209e1b1c15.gif)

### èšç„¦åˆ°æŸä¸€ä½ç½®

é€šè¿‡ä¸Šé¢å·²å®ç°é€‰ä¸­ä»»æ„åŒºé—´æ–‡å­—ï¼Œå†æ¥çœ‹å°†å…‰æ ‡èšç„¦åˆ°æŸä¸€ä½ç½®ï¼Œå°±ç®€å•å¤šäº†ï¼Œåªé€‰å°†èµ·å§‹å’Œç»“æŸèŒƒå›´ä½ç½®è®¾ç½®ç›¸åŒå³å¯ã€‚

```javascript
const selection = document.getSelection()
const range = document.createRange()
const nodes = this.getNodeAndOffset($input, 7, 7)
range.setStart(nodes[0], nodes[1])
range.setEnd(nodes[2], nodes[3])
selection.removeAllRanges()
selection.addRange(range)
```

![getNodeAndOffset1.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662449255433-9315d09c-e752-4ffb-a975-a54c856796e5.gif)

### è¿˜åŸä¹‹å‰çš„é€‰åŒº

åŒæ–‡æœ¬è¾“å…¥æ¡†ä¿å­˜å½“å‰çš„å…‰æ ‡ä½ç½®ï¼Œåœ¨å¯Œæ–‡æœ¬é‡Œï¼Œå¯ä»¥å°†æ•´ä¸ªé€‰åŒºéƒ½ä¿å­˜ä¸‹æ¥ï¼Œç„¶ååœ¨åé¢å¤åŸé€‰åŒºã€‚

```javascript
// ä¿å­˜å…‰æ ‡
$input.addEventListener('mouseup', () => {
  const selection = document.getSelection()
  const range = selection.getRangeAt(0)
  this.lastRange = range
})
// è¿˜åŸå…‰æ ‡
const selection = document.getSelection()
const range = document.createRange()
selection.removeAllRanges()
selection.addRange(this.lastRange)
```

![addRange1.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662453084252-763866a8-f74d-4938-ba88-bbc2fbf85920.gif)

### åœ¨æŒ‡å®šé€‰åŒºæ’å…¥ï¼ˆæ›¿æ¢ï¼‰å†…å®¹

åœ¨é€‰åŒºæ’å…¥å†…å®¹ï¼Œå¯ä»¥ä½¿ç”¨ [Range.insertNode()](https://developer.mozilla.org/zh-CN/docs/Web/API/Range/insertNode) æ–¹æ³•ï¼Œå®ƒè¡¨ç¤ºåœ¨é€‰åŒºçš„èµ·ç‚¹å¤„æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”ä¸ä¼šæ›¿æ¢å½“å‰å·²ç»é€‰ä¸­çš„ï¼Œå¦‚æœéœ€è¦æ›¿æ¢ï¼Œå¯ä»¥å…ˆåˆ é™¤ï¼Œåˆ é™¤é€‰åŒºå¯ä»¥ç”¨ [Range.deleteContent()](https://developer.mozilla.org/zh-CN/docs/Web/API/Range/deleteContents) æ–¹æ³•ã€‚

```javascript
const $text = document.createTextNode('ğŸ˜‚ğŸ˜‚ğŸ˜‚')
this.lastRange.deleteContents()
this.lastRange.insertNode($text)
```

![deleteContent.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662456538724-b365a830-e9dc-4472-aa8f-07e69371008c.gif)
ä»ä¸Šé¢å®¢æœå‘ç°ï¼Œæ’å…¥å†…å®¹åï¼Œå†…å®¹æ˜¯è¢«é€‰åŒºé€‰ä¸­çŠ¶æ€ï¼Œå¦‚æœå¸Œæœ›å…‰æ ‡åœ¨æ’å…¥çš„å†…å®¹åé¢ï¼Œå¯ä»¥ä½¿ç”¨ [Range.setStartAfter()](https://developer.mozilla.org/en-US/docs/Web/API/Range/setStartAfter) è®¾ç½®é€‰åŒºçš„èµ·ç‚¹ä¸ºå…ƒç´ çš„åé¢ï¼Œé»˜è®¤é€‰åŒºçš„ç»ˆç‚¹åœ¨å…ƒç´ çš„åé¢ [Range.setEndAfter()](https://developer.mozilla.org/en-US/docs/Web/API/Range/setEndAfter)ï¼Œæ— é¡»è®¾ç½®ã€‚

```javascript
this.lastRange.setStartAfter($text)
$input.focus()
```

![setStartAfter.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662457953619-1679fb5f-23fb-43cb-b34a-54d1b3b0c4df.gif)
åŒæ ·ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ [Range.setEndBefore](https://developer.mozilla.org/en-US/docs/Web/API/Range/setEndBefore) å’Œ [setStartBefore](https://developer.mozilla.org/en-US/docs/Web/API/Range/setStartBefore)å°†å…‰æ ‡è®¾ç½®åˆ°å†…å®¹çš„å‰é¢ã€‚

### ç»™æŒ‡å®šé€‰åŒºåŒ…è£¹æ ‡ç­¾

è¿˜æœ‰ä¸€äº›æ¯”è¾ƒé«˜çº§çš„ç”¨æ³•åº”ç”¨ï¼Œæ¯”å¦‚ç»™æŸå¥è¯åŠ èƒŒæ™¯æ ‡è®°æ•ˆæœï¼Œç±»ä¼¼ word æ–‡æ¡£æ–‡å­—é€‰ä¸­åŠ èƒŒæ™¯è‰²ã€‚å¯ä»¥é€šè¿‡ [Range.surroundContents()](https://developer.mozilla.org/zh-CN/docs/Web/API/Range/surroundContents) æ–¹æ³•å®ç°ã€‚

![surroundContents.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662462012337-424061e8-e1fc-4cbb-8c49-b6072ca68056.gif)
ä¸è¿‡ï¼Œå½“é€‰åŒºåŒ…å«å¤šä¸ªå…ƒç´ ï¼Œä¹Ÿå°±æ˜¯æ–­å¼€äº†ä¸€ä¸ªé text èŠ‚ç‚¹ï¼ŒåªåŒ…å«äº†èŠ‚ç‚¹çš„å…¶ä¸­ä¸€ä¸ªè¾¹ç•Œï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚
é‚£ä¹ˆæ€æ ·å¯ä»¥è§„é¿è¿™ä¸ªé—®é¢˜ï¼Œå®ç°è·¨å¤šä¸ªèŠ‚ç‚¹é€‰ä¸­æ ‡è®°å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ [extractContents()](https://developer.mozilla.org/zh-CN/docs/Web/API/Range/extractContents)ï¼Œå®ƒä¼šå°†æˆ‘ä»¬çš„é€‰åŒºå¤šèŠ‚ç‚¹ç§»åŠ¨åˆ° `DocumentFragment` å¯¹è±¡ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯

> ä½¿ç”¨ DOM äº‹ä»¶æ·»åŠ çš„äº‹ä»¶ç›‘å¬å™¨åœ¨æå–æœŸé—´ä¸ä¼šä¿ç•™ã€‚HMTL å±æ€§äº‹ä»¶å°†æŒ‰ [Node.cloneNode()](https://developer.mozilla.org/zh-CN/docs/Web/API/Node/cloneNode) æ–¹æ³•åŸæ ·ä¿ç•™å’Œå¤åˆ¶ã€‚HTML id å±æ€§ä¹Ÿä¼šè¢«å…‹éš†ï¼Œå¦‚æœæå–äº†éƒ¨åˆ†é€‰å®šçš„èŠ‚ç‚¹å¹¶å°†å…¶é™„åŠ åˆ°æ–‡æ¡£ä¸­ï¼Œåˆ™å¯èƒ½å¯¼è‡´æ— æ•ˆçš„æ–‡æ¡£ã€‚

ç”¨æ ‡ç­¾åŒ…è£¹è¯¥æ–‡æ¡£ç‰‡æ®µï¼Œç„¶åæ’å…¥ã€‚

```javascript
const $mark = document.createElement('mark')
// this.lastRange.surroundContents($mark)
const fragments = this.lastRange.extractContents()
$mark.append(fragments)
this.lastRange.insertNode($mark)
```

![extractContents.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662894067034-48b18544-3caf-4c99-91aa-9fa3207eafb4.gif)

### å…‰æ ‡/é€‰åŒºçš„ä½ç½®åæ ‡

æœ‰æ—¶æˆ‘ä»¬æƒ³ç¡®å®šæ–‡æœ¬åŒºåŸŸä¸­è¢«é€‰ä¸­çš„éƒ¨åˆ†æˆ–è€…å…‰æ ‡çš„è§†çª—åæ ‡ï¼Œä»¥æ­¤å¯ä»¥å°†ç±»ä¼¼å¤‡æ³¨æˆ–è€…æ‚¬æµ®æ¡†å®šä½åˆ°é™„è¿‘ã€‚è¿™é‡Œå¯ä»¥ä½¿ç”¨ [Range.getBoundingClientRect()](https://developer.mozilla.org/zh-CN/docs/Web/API/Range/getBoundingClientRect) APIï¼Œå®ƒè¿”å›ä¸€ä¸ª DOMRect å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å°†èŒƒå›´ä¸­çš„å†…å®¹åŒ…å›´èµ·æ¥ï¼›å³è¯¥å¯¹è±¡æ˜¯ä¸€ä¸ªå°†èŒƒå›´å†…æ‰€æœ‰
å…ƒç´ åŒ…å›´èµ·æ¥çš„çŸ©å½¢ã€‚

```javascript
const pos = this.lastRange.getBoundingClientRect()
const highlight = document.getElementById('highlight')
highlight.style.left = `${pos.x}px`
highlight.style.top = `${pos.y}px`
highlight.style.width = `${pos.width}px`
highlight.style.height = `${pos.height}px`
```

```css
#highlight {
  position: absolute;
  background-color: aqua;
}
```

![getBoundingClientRect.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662903500575-0654dcc3-7084-4f44-ad79-e535855ebe8b.gif)
é€‰ä¸­äº† 3 è¡Œï¼Œä½†ä¸æ˜¯å®Œæ•´çš„ 3 è¡Œï¼Œç»™å›çš„ä¿¡æ¯æ˜¯ä¸€ä¸ªæœ€å°åŒ…è£¹é€‰åŒºçš„çŸ©å½¢ä½ç½®åæ ‡ï¼Œå¦‚æœè¿˜éœ€è¦çŸ¥é“é€‰å–ä¸­æ¯ä¸ªå…ƒç´ æ›´è¯¦ç»†çš„ä½ç½®åæ ‡ï¼Œå¯ä»¥ä½¿ç”¨ [Range.getClientRects()](https://developer.mozilla.org/zh-CN/docs/Web/API/Range/getClientRects)ï¼Œå®ƒè¿”å›çš„æ˜¯ä¸€ä¸ª DOMRect å¯¹è±¡åˆ—è¡¨ï¼Œè¡¨ç¤º Range åœ¨å±å¹•ä¸Šæ‰€å çš„åŒºåŸŸã€‚è¿™ä¸ªåˆ—è¡¨ç›¸å½“äºæ±‡é›†äº†èŒƒå›´ä¸­æ‰€æœ‰å…ƒç´ è°ƒç”¨ [Element.getClientRects()](https://developer.mozilla.org/zh-CN/docs/Web/API/Element/getClientRects)æ–¹æ³•æ‰€å¾—åˆ°çš„ç»“æœã€‚

```javascript
this.lastRange.getClientRects()
```

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22627045/1662904506911-91a30004-51d1-4dd8-8d03-5f7743d9caf4.png)
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22627045/1662904530240-a2695b2a-09bf-40cb-b75c-1f04e862b0fc.png)
Selection&Range çš„ API å¾ˆå¤šï¼Œå¸¸ç”¨çš„å¤§è‡´ä»¥ä¸Šåˆ—ä¸¾çš„ï¼ŒåŒæ ·ç®€å•æ€»ç»“ä¸€ä¸‹
![](https://cdn.nlark.com/yuque/0/2022/jpeg/22627045/1663151006797-58eaa2f3-bf49-4ff3-a493-fff785bfa05a.jpeg)

## @çš„åŠŸèƒ½å®ç°

å¦‚æœä½ å·²ç»ç†Ÿæ‚‰äº†ä¸Šé¢çš„ã€ŒåŸºæ“ã€ï¼Œé‚£ä¹ˆå¯¹äºå®ç°ä¸€ä¸ª@åŠŸèƒ½å·²ç»æˆåŠŸäº†ä¸€åŠï¼Œå‰©ä¸‹çš„ä¸€åŠå°±æ˜¯æ€è·¯äº†ï¼Œå¤§è‡´åˆ†ä¸ºå¦‚ä¸‹å‡ æ­¥ï¼š

1. ç›‘å¬ç”¨æˆ·è¾“å…¥äº†`@`å­—ç¬¦ï¼Œå±•ç¤ºç”¨æˆ·åˆ—è¡¨ï¼›
1. ç‚¹å‡»ç”¨æˆ·ï¼Œå¯¼è‡´è¾“å…¥æ¡†å¤±ç„¦ï¼ŒåŠæ—¶ä¿å­˜å…‰æ ‡ä¿¡æ¯ï¼›
1. ç‚¹å‡»å®Œæˆï¼Œç”¨æˆ·åˆ—è¡¨éšè—ï¼Œæ¢å¤è¾“å…¥æ¡†çš„å…‰æ ‡ï¼Œç„¶ååœ¨å…‰æ ‡åæ’å…¥ç”¨æˆ·åï¼›

é¦–å…ˆæˆ‘ä»¬å†™å¥½ `HTML`ï¼Œ`CSS` éƒ¨åˆ†åœ¨è¿™é‡Œçœç•¥

```html
<!-- å¯Œæ–‡æœ¬èŠå¤©æ¶ˆæ¯è¾“å…¥æ¡† -->
<div
  class="chat-input"
  ref="chatInput"
  contenteditable="true"
  placeholder="è¯·è¾“å…¥å†…å®¹"
  @input="inputChatContent"
  @blur="chatContentBlur"
  @mouseup="chatContentMouseup"
></div>
<!-- ç”¨æˆ·åˆ—è¡¨æµ®çª— -->
<ul class="popper" v-show="isShowUserList" ref="popper" :style="popperStyle" v-click-out-hide>
  <li v-for="(item, index) in userList" :key="index" @click="selectUser(item)">
    <el-row>{{item.name}}</el-row>
  </li>
</ul>
```

æ¥ç€æˆ‘ä»¬ç›‘å¬å¯Œæ–‡æœ¬çš„`input`äº‹ä»¶ï¼Œå½“ç›‘å¬åˆ° @ å­—ç¬¦ï¼Œå±•ç¤ºç”¨æˆ·åˆ—è¡¨ï¼Œå¦åˆ™éšè—ã€‚äºæ­¤åŒæ—¶ï¼Œä½¿ç”¨ Range.getBoundingClientRect() è·å–å…‰æ ‡çš„ä½ç½®ï¼Œè¿™æ ·æ‰èƒ½å°†ç”¨æˆ·åˆ—è¡¨æµ®æ¡†å®šä½åˆ°å…‰æ ‡é™„è¿‘ã€‚

```javascript
/**
 * è¾“å…¥èŠå¤©å†…å®¹
 * @param {*} ev
 */
inputChatContent(ev) {
  if (ev.data === '@') {
    const pos = this.getCaretPos()
    this.showUserList()
    this.$nextTick(() => {
      this.setUserListPos(pos)
    })
  } else {
    this.hideUserList()
  }
},

/**
 * è·å–å…‰æ ‡ä½ç½®
 * @returns
 */
getCaretPos() {
  const range = this.getRange()
  const pos = range.getBoundingClientRect()

  return pos
},

/**
 * è®¾ç½®ç”¨æˆ·åˆ—è¡¨çš„ä½ç½®
 * @param {*} pos
 */
setUserListPos(pos) {
  const $popper = this.$refs.popper
  const panelWidth = $popper.offsetWidth
  const panelHeight = $popper.offsetHeight
  const { x, y } = pos

  this.popperStyle = {
    top: y - panelHeight - 20 + 'px',
    left: x - panelWidth / 2 + 'px'
  }
},

hideUserList() {
  this.isShowUserList = false
},

showUserList() {
  this.isShowUserList = true
},
```

å½“ç‚¹å‡»ç”¨æˆ·åˆ—è¡¨æ—¶ï¼Œè¾“å…¥æ¡†ä¼šå¤±ç„¦ï¼Œæ­¤æ—¶å…ˆå°†å…‰æ ‡ä¿å­˜èµ·æ¥ï¼ŒåŒæ—¶åˆ›å»ºå°†è¦æ’å…¥çš„ç”¨æˆ·åæ–‡æœ¬èŠ‚ç‚¹ï¼Œç„¶åæ¢å¤å…‰æ ‡ï¼Œå† `Range.insetNode()` å°†ç”¨æˆ·åæ–‡æœ¬èŠ‚ç‚¹ `Range.insetNode()` æ’å…¥åˆ°é€‰åŒºï¼Œæœ€å `Selection.removeAllRanges()` ç§»é™¤æ‰€æœ‰é¡µé¢é€‰åŒºï¼Œ`Selection.addRange()` æ’å…¥å½“å‰é€‰åŒºã€‚

```javascript
 /**
 * é€‰æ‹©ç”¨æˆ·
 */
selectUser(user) {
  // è®©å¤±ç„¦äº‹ä»¶å…ˆæ‰§è¡Œ
  setTimeout(() => {
    this.hideUserList()
    this.insertContent(user)
  })
},

/**
 * æ¢å¤å…‰æ ‡
 */
restoreCaret() {
  if (this.lastRange) {
    const selection = window.getSelection()
    selection.removeAllRanges()
    selection.addRange(this.lastRange)
  }
},

/**
 * æ’å…¥å†…å®¹
 * @param {*} data
 */
insertContent(data) {
  this.restoreCaret() // è¿˜åŸå…‰æ ‡

  const selection = window.getSelection()
  const range = selection.getRangeAt(0)
  range.collapse(false) // æŠ˜å é€‰åŒºï¼Œå…‰æ ‡ç§»åˆ°æœ€å
  range.insertNode(data.content)
  range.collapse(false)

  selection.removeAllRanges()
  selection.addRange(range)
}
```

## ![at1.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662907721684-7990ab06-9e4c-4c6c-b67b-ad04ef8a55c6.gif)

## @åŠŸèƒ½åŠ å¼ºç‰ˆ

ä»¥ä¸Šæ˜¯ç®€å•å®ç°äº†@ åŠŸèƒ½ï¼Œåœ¨å®é™…åº”ç”¨ä¸­è¿˜æœ‰æ›´å¤šæå‡ç”¨æˆ·ä½“éªŒçš„åœ°æ–¹

- å½“å‰é€šè¿‡é€€å›é”®åˆ é™¤ç”¨æˆ·å`@xxx`ï¼Œå‘ç°åˆ é™¤çš„æ˜¯é€ä¸ªå­—ç¬¦ï¼Œè€Œç”¨æˆ·æ›´å¤šæƒ³è¦çš„æ˜¯æŒ‰ä¸€ä¸‹é€€å›é”®ï¼Œåˆ é™¤æ•´ä¸ªç”¨æˆ·åï¼›
- å‘é€å‡ºå»æ€æ ·è§£ææˆåç«¯èƒ½è¯†åˆ«çš„ç‰¹å®šçš„æ•°æ®ç»“æ„ï¼Œå¹¶ä¸”ç‰¹å®šçš„æ•°æ®ç»“æ„æ€æ ·è½¬æ¢å›å¯Œæ–‡æœ¬å‘¢ï¼Ÿ

![at2.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662908992043-444da205-b539-4036-b02e-6c1672e64f00.gif)
æš‚ä¸”å¸¦è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œæ¥ç€æ€æ ·è§£å†³å‘¢ï¼Ÿ

### å®ç°æ•´ä½“åˆ é™¤ç”¨æˆ·å

é¦–å…ˆæƒ³åˆ°çš„æ˜¯ç”¨æˆ·åæ’å…¥å¯Œæ–‡æœ¬æ˜¯ä¸€ä¸ªæ ‡ç­¾ï¼ŒæŒ‰ä¸€ä¸‹é€€å›é”®ï¼Œå°±èƒ½åˆ é™¤æ•´ä¸ªæ ‡ç­¾ï¼Ÿç­”æ¡ˆæ˜¯ä¸èƒ½ï¼Œå¯Œæ–‡æœ¬æ ‡ç­¾é‡Œçš„æ–‡å­—åœ¨æ²¡æœ‰é€‰ä¸­æƒ…å†µä¸‹éƒ½æ˜¯é€ä¸ªåˆ é™¤ã€‚é™¤éè¯¥å…ƒç´ æ˜¯ä¸å¯ç¼–è¾‘å…ƒç´  `span.contentEditable = false`ã€‚
![at3.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662909400591-181e6928-75f6-40a9-80a2-6f163109b91d.gif)
è¿™é‡Œè¦å°† `@xxx`æ”¾å…¥ä¸å¯ç¼–è¾‘æ ‡ç­¾ä¸­ï¼Œåˆ é™¤çš„æ—¶å€™æ‰èƒ½ä¸€èµ·åˆ ã€‚æ­¤æ—¶ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ¯æ¬¡æ’å…¥ç”¨æˆ·æ ‡ç­¾åï¼Œå¤šå‡ºä¸€ä¸ª@ å­—ç¬¦ï¼Œæ‰€ä»¥åœ¨ä¹‹å‰å·²ç»è¾“å…¥çš„ @ å­—ç¬¦å°±éœ€è¦åœ¨æ’å…¥æ ‡ç­¾å‰éœ€è¦åˆ é™¤æ‰ã€‚å…·ä½“å®ç°æ˜¯æ‰¾åˆ°é€‰åŒºæ‰€åœ¨çš„å¼€å§‹èŠ‚ç‚¹ `Range.startContainer`ï¼Œå†æ‰¾åˆ°é€‰åŒºç»“æŸä½ç½®çš„åç§»é‡ `Range.endOffset` ï¼Œæ­£å¸¸æƒ…å†µä¸‹é€‰åŒºç»“æŸä½ç½®çš„å‰ä¸€ä¸ªå°±æ˜¯ @å­—ç¬¦ï¼Œé€‰ä¸­åˆ é™¤å³å¯ã€‚

```javascript
/**
 * åˆ é™¤è¾“å…¥æ¡†ä¸­å…‰æ ‡ä½ç½®ç°æœ‰çš„@å­—ç¬¦
 */
deleteCaretAtCode() {
  const range = this.getRange()
  // å…‰æ ‡å¼€å§‹èŠ‚ç‚¹å’Œå…‰æ ‡åœ¨èŠ‚ç‚¹ä¸Šçš„åç§»é‡ï¼Œæ‰¾åˆ°å…‰æ ‡å‡†ç¡®ä½ç½®ï¼Œé€‰ä¸­å…‰æ ‡ä½ç½®å‰ä¸€ä¸ªå­—ç¬¦èŒƒå›´å¹¶åˆ é™¤ï¼Œ
  const node = range.startContainer
  const end = range.endOffset

  // å¼€å§‹èŠ‚ç‚¹å†…å®¹æœ€åä¸€ä¸ªå­—ç¬¦æ˜¯@ï¼Œåˆ é™¤ï¼Œå¦åˆ™ä¸åˆ é™¤
  if (node.textContent[end - 1] === '@') {
    range.setStart(node, end ? end - 1 : 0)
    range.deleteContents()
  }
},

/**
 * è½¬æ¢è¦æ’å…¥å…‰æ ‡ä½ç½®çš„å†…å®¹
 * @param {*} data
 */
parseContent(data) {
  const { type = 'text', name } = data
  let content = null

  // type æ˜¯æ’å…¥å†…å®¹ç±»å‹ï¼Œå¯èƒ½æ˜¯æ–‡æœ¬ã€@æ ‡ç­¾ã€å›¾ç‰‡ã€è¡¨æƒ…ç­‰
  if (type === 'text') {
    content = document.createTextNode(name)
  } else if (type === 'at') {
    // åˆ é™¤è¾“å…¥æ¡†ä¸­å…‰æ ‡ä½ç½®ç°æœ‰çš„@å­—ç¬¦
    this.deleteCaretAtCode()

    const $span = document.createElement('span')
    $span.contentEditable = false
    $span.classList.add('tag')
    $span.innerHTML = `@${name}`

    // æ’å…¥ä¸€ä¸ªç©ºæ ¼å­—ç¬¦ï¼ˆ\u0010ï¼‰åˆ°@æ ‡ç­¾åé¢ï¼Œå¯ä»¥è§£å†³éƒ¨åˆ†æµè§ˆå™¨ä¸Šå…‰æ ‡åœ¨èŠå¤©è¾“å…¥æ¡†åé¢
    const $space = document.createTextNode('\u0010')
    const frag = document.createDocumentFragment()

    frag.appendChild($span)
    frag.appendChild($space)

    content = frag
  }
  return content
},

 /**
 * æ’å…¥å†…å®¹
 * @param {*} data
 */
insertContent(data) {
  this.restoreCaret() // è¿˜åŸå…‰æ ‡

  const selection = window.getSelection()
  const range = selection.getRangeAt(0)
  range.collapse(false) // æŠ˜å é€‰åŒºï¼Œå…‰æ ‡ç§»åˆ°æœ€å

  const pc = this.parseContent(data)
  range.insertNode(pc)
  range.collapse(false)

  selection.removeAllRanges()
  selection.addRange(range)
}
```

![at4.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662910427167-f2a84f0b-ff53-47e1-864e-38f05e15bfb4.gif)

### ä¸€äº›å…¼å®¹å¤„ç†

å¯èƒ½ä½ å·²ç»æ³¨æ„åˆ°äº†ï¼Œåœ¨ç”¨æˆ·æ ‡ç­¾`@xxx`åé¢è¿½åŠ äº†ä¸€ä¸ªç©ºæ ¼å­—ç¬¦ï¼Œè¿™æ ·å…‰æ ‡å¯ä»¥æ˜¾ç¤ºå‡ºæ¥ï¼Œä¸è¿‡åœ¨ç”¨é€€æ ¼é”®éœ€è¦æŒ‰ä¸¤æ¬¡åˆ é™¤æ ‡ç­¾ï¼Œè¿™é‡Œå…·ä½“çš„è¦çœ‹ä¸šåŠ¡éœ€è¦äº†ã€‚
æ³¨æ„çš„æ˜¯åœ¨ Mac Chromeï¼ˆV104ï¼‰ä¸Šï¼Œå¦‚æœåœ¨æ ‡ç­¾åé¢ä¸è¿½åŠ å­—ç¬¦ï¼Œå…‰æ ‡ä¼šåœ¨å¤–å±‚å¯Œæ–‡æœ¬æ ‡ç­¾åé¢ï¼Œåœ¨éç¼–è¾‘æ ‡ç­¾ååŠ ä»»æ„å­—ç¬¦æ˜¯æ­£å¸¸çš„ã€‚![chat-input-cursor-out.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1663148352142-96a6a343-c4f3-4185-9b7b-b6724faf9e9b.gif)
ç»è¿‡æµ‹è¯• Firefox æµè§ˆå™¨æœ‰è¿™æ ·çš„ bugï¼šç”¨æˆ·æ ‡ç­¾`@xxx`æ²¡æœ‰æ­£ç¡®çš„æ’å…¥åˆ°å¯Œæ–‡æœ¬è¾“å…¥æ¡†çš„ä½ç½®ï¼Œè€Œæ˜¯æ’å…¥åˆ°äº†ç”¨æˆ·åˆ—è¡¨ç‚¹å‡»çš„é‚£ä¸€é¡¹ä¸Šäº†ã€‚![firefox.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662968166386-06ffeb53-6b4a-4a4d-8281-26bb8f3838e1.gif)
å¤§èƒ†æ¨æµ‹ Firefox å°†æ™®é€šå…ƒç´ ä¹Ÿå¯ä»¥è®¾ç½®å…‰æ ‡ï¼Œè¿™æ ·ç‚¹å‡»ç”¨æˆ·åˆ—è¡¨æŸä¸€é¡¹å…ƒç´ æ—¶ï¼Œè¯¥å…ƒç´ è·å¾—å…‰æ ‡ï¼Œå†è·å–æ–°é€‰åŒº `selection.getRangeAt(0)`å…¶å®æ˜¯åœ¨ç‚¹å‡»çš„è¿™ä¸ªå…ƒç´ ä¸Šï¼Œéæ¢å¤çš„å¯Œæ–‡æœ¬è¾“å…¥æ¡†ä¸Šï¼Œç„¶åæ’å…¥ç”¨æˆ·æ ‡ç­¾ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„æƒ…æ™¯ã€‚
è¿™é‡Œæˆ‘çš„è§£å†³æ–¹æ³•æ˜¯å°†ç”¨æˆ·åˆ—è¡¨é¡¹è®¾ç½®ä¸ºä¸å¯é€‰ä¸­çš„ï¼Œè‡ªç„¶å°±æ— æ³•è·å–å…‰æ ‡ã€‚

```css
.popper li {
  /* ç”¨æˆ·ä¸èƒ½é€‰ä¸­æ–‡æœ¬ firfox éç¼–è¾‘ç¼–è¾‘å…ƒç´ ä¹Ÿå¯é€‰ä¸­ */
  user-select: none;
  -webkit-user-select: none;
  list-style: none;
  padding: 10px;
}
```

![Firefox1.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662969574165-f5ad5028-0b3c-4a82-a70f-8d978cf19362.gif)
æˆ‘ä»¬å†çœ‹çœ‹å† Safari ä¸Šçš„è¡¨ç°
![Safari1.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662977831761-d5da8f13-d551-454a-b69f-be6475114777.gif)
å‘ç°æ˜¯æ²¡æœ‰æŒ‰ç…§é¢„æƒ³çš„åˆ é™¤æ‰å‰ç½®çš„`@`å­—ç¬¦çš„ï¼ŒæŸ¥çœ‹æ§åˆ¶å°æœ‰æŠ¥é”™
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22627045/1662977805511-ffbb8962-4456-42fe-917c-ed310575d9b8.png)
å¤§è‡´æ„æ€æ˜¯ `selection.getRangeAt(0)`ä¸­ç¬¬ 0 ä½æ˜¯è¶…å‡ºå…è®¸çš„èŒƒå›´çš„ï¼Œéš¾é“åœ¨è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹çš„æƒ…æ™¯ä¸‹ï¼ŒSafari é»˜è®¤å°†é€‰åŒºç»™æ¸…ç©ºäº†ï¼Ÿé€šè¿‡å®éªŒå‘ç°ç¡®å®å¦‚æ­¤

```javascript
// è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹å’Œè·å–ç„¦ç‚¹æ—¶æ‰“å°é€‰åŒºä¸ªæ•°
const selection = window.getSelection()
console.log('selection.rangeCount: ', selection.rangeCount)
```

![Safari2.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662978608482-02437102-37b2-45c2-9b98-042ba882c5c1.gif)
è€Œæ­£å¸¸å…¶ä»–æµè§ˆå™¨é€‰åŒºä¸ªæ•°ä¿æŒä¸å˜
![Safari3.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662978794016-4b5c68bf-d7e6-4765-a19d-029bce17351f.gif)
é‚£æ€æ ·è§£å†³è¿™ç§æƒ…æ™¯å‘¢ï¼Ÿæˆ‘ä»¬æ˜¯åœ¨è¾“å…¥æ¡†å¤±ç„¦çš„æ—¶å€™ä¿å­˜é€‰åŒºçš„ï¼Œæ­¤æ—¶ Safari å·²ç»æ¸…ç©ºäº†é€‰åŒºï¼Œå¯¼è‡´è¿™ä¸ªæ—¶å€™ä¿å­˜çš„é€‰åŒºæ˜¯ç©ºçš„ï¼Œå› æ­¤æˆ‘ä»¬è¦å°†é€‰åŒºä¿å­˜å‰ç½®ä¸€ä¸‹ï¼Œåœ¨è¾“å…¥`@`å­—ç¬¦æ—¶å€™å°±ä¿å­˜ä¸€ä¸‹é€‰åŒºï¼ˆå…‰æ ‡ï¼‰ï¼Œå¯ä»¥è¿™æ ·åš

```javascript
/**
 * è¾“å…¥èŠå¤©å†…å®¹
 * @param {*} ev
 */
inputChatContent(ev) {
  if (ev.data === '@') {
    // åœ¨è¾“å…¥@å­—ç¬¦æ—¶å€™å°±ä¿å­˜ä¸€ä¸‹å…‰æ ‡
    this.saveCaret()
    const pos = this.getCaretPos()
    this.showUserList()
    this.$nextTick(() => {
      this.setUserListPos(pos)
    })
  } else {
    this.hideUserList()
  }
},
```

![Safari.gif](https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662978984982-ce1af8a4-16a6-4aa0-8111-baa4e25bc5f8.gif)

## æ€»ç»“

æœ¬æ–‡ä»¥â€œå®Œç¾â€å®ç°ä¸€ä¸ª@ åŠŸèƒ½ä¸ºå¼•å­ï¼Œä»‹ç»äº† input/textarea æ–‡æœ¬è¾“å…¥æ¡†å’Œå¯Œæ–‡æœ¬çš„é€‰åŒºæ“ä½œã€‚å¹¶åœ¨æ­¤åŸºç¡€ä¸Šç»“åˆ@ åŠŸèƒ½çš„å®ç°æ€è·¯ï¼Œè¾¹å®è·µè¾¹æ”¹è¿›ï¼Œä¸ä¹æœ‰å¾ˆå¤šåœ°æ–¹æ²¡æœ‰è€ƒè™‘å‘¨å…¨çš„ï¼Œä»…å½“ä½œå­¦ä¹ çš„ demo å°±å¥½ï¼Œæ¬¢è¿æŒ‡æ­£ã€‚æœ¬æ–‡åœ¨çº¿æ¡ˆä¾‹å¯ä»¥ç‚¹[è¿™é‡Œ](https://wuwhs.gitee.io/demo/realize-at/)ï¼Œå®Œï½
